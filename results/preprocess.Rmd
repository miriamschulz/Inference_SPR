---
title: "Inference SPR results script: Preprocessing"
author: "Miriam Schulz"
date: "9/15/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



## About

This R markdown script preprocesses the raw SPR results from PCIbex.

Reads in the raw `results.csv` file downloaded from PCIbex and merges it with the items + pretest results.

Returns the processed `results_reads.csv` dataframe.

Preprocessing steps: 

- exclude participants with low accuracy and/or very long reading times
  (determined)
- add unique subject numbers (1-40)
- annotate list order, list number and trial number
- annotate word position with respect to the critical target word 
  (target = 0, precritical = -1, spillover1 = 1, etc)
- annotate plausibility rating accuracy + reaction times

Most of the above steps are accomplished by functions stored separately in `results_SPR_functions.R`.


## Preliminaries

```{r, include = FALSE}
# Workspace, libraries, functions
rm(list = ls())  # clear workspace (optional)
library(tidyverse)
source("functions.R") # custom functions 
```

Read in data, remove participants and add Subject IDs:

```{r}
# Read in raw data
df <- readPCibex("results.csv")

# Remove participants
# Participant with very long RTs who timed out: 
exclude.participants <- c("42540fa1be6151d9f8ae49bb3098494c")
df <- filter(df, !IPhash %in% exclude.participants)

# Add subject numbers:
df.subjects <- data.frame(IPhash = unique(df$IPhash),
                          Subject = 1:length(unique(df$IPhash)))
# use plyr::join instead of merge to preserve original row ordering:
df <- plyr::join(df.subjects, df)
```

Next, split the data into separate data frames for reading times and survey/demographics.

The `getReads()` function annotates:

- list order, Latin list number and trial position
- word position with respect to the critical target word 
- plausibility ratings: accuracy and reaction time

```{r}
reads <- getReads(df)
survey <- getSurvey(df)
```


## Add pretest results

Read in the items + pretest results and merge with the reading time data frame:

```{r}
# Open items file with pretest results
items <- read.csv("items_pretests.csv", header = TRUE)

# Add new item numbers:
items$ItemPretests <- items$Item  # save original item number
items$Item <- rep(1:40, each=4)

# Select columns 
items <- items[, c(1,20,2:6)]

# Merge and reorder
reads.export <- merge(items, reads, by=c("Item", "Cond"), all.y = TRUE)
reads.export <- reads.export[, c(1, 3, 2, 4:11, 13, 27, 22, 15:19, 23:26)]
reads.export <- reads.export[ with(reads.export, order(Item, Cond, Region)), ]
```

## Export 

Two separate files are exported:

1. `results_reads.csv` for the reading time data, and
2. `results_survey.csv` for the survey/demographics data, including age, gender, handedness, language background and post-experimental survey data

```{r}
write.csv(reads.export, "results_reads.csv", row.names = FALSE)
write.csv(survey, "results_survey.csv", row.names = FALSE)
```

