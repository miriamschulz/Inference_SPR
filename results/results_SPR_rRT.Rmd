---
title: "rRT analysis"
author: "Miriam Schulz"
date: "10/11/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, fig.height = 6, fig.width = 9)
```


## About

This script contains an rRT analysis of the inference reading time data (SPR1) based on the rERP approach in Brouwer, Delogu & Crocker (2020). 


## Read data and preprocess

Read in the data, scale the predictors, etc.

```{r include = FALSE}
# Workspace and libraries
rm(list = ls())
library(tidyverse)
library(lme4)
library(broom)      # for tidy(modeloutput)
library(gridExtra)  # for grid.arrange()
library(grid)       # for textGrob() => change grid.arrange plot name font size 
library(sciplot)    # for se() 
library(RColorBrewer)
source("results_SPR_functions.R")      # preprocessing and helper functions
source("results_SPR_functions_rRT.R")  # rRT functions
```


```{r}
# Read data
df <- read.csv("results_reads.csv", header = TRUE)

# Exclude filler and practice trials
df <- filter(df, Item < 100)

# Transform variables to factors
df$Cond <- as.factor(df$Cond)
df$Item <- as.factor(as.numeric(as.character(df$Item)))
df$Subject <- as.factor(as.numeric(as.character(df$Subject)))

# Transform the binary plausibility predictor to numeric, then to factor
df$Plausible <- as.factor(ifelse(df$Plausible == "Yes", 1, 0))

# Exclude data
df <- filterRTs(df, criteria = c(50, 2500), method = "thresholds",
                remove.incorrect = TRUE, remove.contexts = 500)

# Invert predictor scales 
#df$AssociationRating <- df$AssociationRating - 7
#df$CoherenceRating <- df$CoherenceRating - 7
#df$InferenceRating <- df$InferenceRating - 7

# Extract precritical RT -1 and add to df:
df.precrit1 <- filter(df, Region == -1) %>% 
  dplyr::select(Item, Cond, Subject, RT) %>% 
  rename(RT_precrit1 = RT)
df <- merge(df, df.precrit1, by = c("Item", "Cond", "Subject"))

# Extract precritical RT -2 and add to df:
df.precrit2 <- filter(df, Region == -2) %>% 
  dplyr::select(Item, Cond, Subject, RT) %>% 
  rename(RT_precrit2 = RT)
df <- merge(df, df.precrit2, by = c("Item", "Cond", "Subject"))

# Add log-transformed RTs
df$logRT <- log(df$RT)
df$logRT_precrit1 <- log(df$RT_precrit1)
df$logRT_precrit2 <- log(df$RT_precrit2)

# Rename variables 
rating_colnames <- str_remove(names(df), "Rating")
names(df) <- rating_colnames
df <- rename(df, ProdNorms = ProductionPercentage)

# Order df by Region
#df <- arrange(df, Region, Item, Cond)
df <- arrange(df, Region)

# Scale predictors (careful: needs to be performed AFTER removing data)
df$Association <- scale(df$Association)
df$Inference <- scale(df$Inference)
df$Coherence <- scale(df$Coherence)
df[, c("RT_precrit1", "RT_precrit2","logRT_precrit1","logRT_precrit2")] <- 
  lapply(df[, c("RT_precrit1", "RT_precrit2","logRT_precrit1","logRT_precrit2")], scale)
```


### Define model parameters

Define general model parameters:

- regions to model
- whether to use raw or log-transformed RTs
- which kind of model to run:
  - "lm": simple LM
  - "lm.by.subj": by-subject LMs
  - "lmer": LMER

```{r}
regions <- -1:2
log.RTs <- TRUE
m.type = "lm.by.subj"

if (log.RTs == TRUE) {
  DV <- "logRT"
  precrit1 <- "logRT_precrit1"
  precrit2 <- "logRT_precrit2"
  y.unit <- "Log RT"
  y.range <- c(5.55, 5.70)
  y.range.res <- c(-0.07, 0.07)
} else {
  DV <- "RT"
  precrit1 <- "RT_precrit1"
  precrit2 <- "RT_precrit2"
  y.unit <- "Raw RT (ms)"
  y.range <- c(260, 320)
  y.range.res <- c(-20, 20)
}
```


### Inspect the spread of variation across regions 

Check the *range* of the reading times in the critical regions (i.e. the spread of the variation).

Larger ranges implies that the residuals will be larger due to the increased amount of gvariation in that region.


```{r}
# Density plot
ggplot(filter(df, Region %in% -2:2),
       #aes(x = RT, group = Region, fill = factor(Region))) +
       aes(x = RT, group = Region, color = factor(Region))) +
  geom_density(adjust=0.8) +
  #geom_histogram(alpha=.5, position = "identity") +
  theme_minimal() +
  xlim(c(100, 900)) +
  #scale_fill_manual(values = c("-1" = "black", "0" = "grey",
  scale_color_manual("Region",
                     values = c("-2" = "yellow", "-1" = "orange", "0" = "black",
                                "1" = "blue", "2" = "lightblue"),
                     labels = c("precrit-2", "precrit-1", "crit",
                                "spillover1", "spillover2")) + 
  ggtitle("Spread of RTs by Region")

# Individual histograms
for (r in-1:2) {
  print(paste0("Region: ",
               r,
               " - Range: ",
               paste(range(filter(df, Region == r)$RT),
                     collapse = "-"),
               "ms"))
  hist(
    filter(df, Region == r)$RT,
    breaks = 20,
    xlim = c(100, 900),
    ylim = c(0, 800),
    xlab = "RT",
    col = "steelblue",
    #add = ifelse(r >= 0, TRUE, FALSE),
    main = paste0("RTs in region: ", r)
  )
}

lmer(RT ~ Region + (1|Subject) + (1|Item),
             data = filter(df, Region %in% regions))
```



## Models 


### Intercept (baseline) LM model

Following the logic of Brouwer et al. (2020), the analysis starts with a baseline model of the variance in the signal. 
The baseline model assumes that no factors were manipulated and that all trials belong to the same condition. 
Therefore, the resulting estimate for each trial in a given region will simply be the average over all trials (and conditions; equivalent to an intercept-only model) in that region. 

Unlike in rERP modeling, different models do not need to be fitted for different electrodes, but like in rERP modeling, different models will be fitted for each subject ($N=40$) and time point (i.e., region, $N=4$: pre-critical region, critical region, post-critical region 1, post-critical region 2), yielding a total of $40 * 4 = 160$ models.

However, here we first start with an even simpler baseline model averaging over subjects.

```{r, results = FALSE}
# Model formula
m.formula <- as.formula(paste0(DV, " ~ 1"))

# Run a model for each region
#m.intercept <- runModels(df, m.type, m.formula, regions = regions)

# Generate plots
#p <- generatePlots(m.intercept, "Intercept", m.type,
#                   DV, y.unit, y.range, y.range.res) #, y.range.coefs

# Run model(s) and generate plots 
modelAndPlot("Intercept",
             m.formula,
             df,
             m.type,
             regions,
             DV, 
             y.unit, 
             y.range, 
             y.range.res)
```



### Models with a single predictor 


#### Intercept + binary Plausibility LM

```{r, results = FALSE}
m.formula <- as.formula(paste0(DV, " ~ 1 + Plausible"))
modelAndPlot("Intercept+Plausibility",
             m.formula,
             df,
             m.type,
             regions,
             DV, 
             y.unit, 
             y.range, 
             y.range.res)
```



#### Intercept + Association LM

```{r, results = FALSE}
m.formula <- as.formula(paste0(DV, " ~ 1 + Association"))
modelAndPlot(
  "Intercept+Association",
  m.formula,
  df,
  m.type,
  regions,
  DV,
  y.unit,
  y.range,
  y.range.res
)

```


#### Intercept + Coherence LM

```{r, results = FALSE}
m.formula <- as.formula(paste0(DV, " ~ 1 + Coherence"))
modelAndPlot(
  "Intercept+Coherence",
  m.formula,
  df, m.type, regions, DV,
  y.unit, y.range, y.range.res
)
```


#### Intercept + Inference LM

```{r, results = FALSE}
m.formula <- as.formula(paste0(DV, " ~ 1 + Inference"))
modelAndPlot(
  "Intercept+Inference",
  m.formula,
  df, m.type, regions, DV,
  y.unit, y.range, y.range.res
)
```


#### Intercept + PrecritRT 1 LM

```{r, results = FALSE}
m.formula <- as.formula(paste0(DV, " ~ 1 + ", paste0(precrit1)))
modelAndPlot(
  "Intercept+PrecritRT1",
  m.formula,
  df, m.type, regions, DV,
  y.unit, y.range, y.range.res
)

```


#### Intercept + PrecritRT 2 LM

```{r, results = FALSE}
m.formula <- as.formula(paste0(DV, " ~ 1 + ", precrit2))
modelAndPlot(
  "Intercept+PrecritRT2",
  m.formula,
  df, m.type, regions, DV,
  y.unit, y.range, y.range.res
)
```



### Models with more than 1 predictor

#### Intercept + Association + Coherence 

```{r, results = FALSE}
m.formula <- as.formula(paste0(DV, " ~ 1 + Association + Coherence"))
modelAndPlot(
  "Intercept+Association+Coherence",
  m.formula,
  df, m.type, regions, DV,
  y.unit, y.range, y.range.res
)

```


#### Intercept + Association + Coherence + Precrit_RT1

```{r, results = FALSE}
m.formula <- as.formula(paste0(DV, " ~ 1 + Association + Coherence + ", precrit1))
modelAndPlot(
  "Intercept+Association+Coherence+Precrit1",
  m.formula,
  df, m.type, regions, DV,
  y.unit, y.range, y.range.res
)
```


#### Intercept + Association + Inference + Precrit_RT1

```{r, results = FALSE}
m.formula <- as.formula(paste0(DV, " ~ 1 + Association + Inference + ", precrit1))
modelAndPlot(
  "Intercept+Association+Inference+Precrit1",
  m.formula,
  df, m.type, regions, DV,
  y.unit, y.range, y.range.res
)
```


#### Intercept + Association + Coherence + Precrit_RT2

```{r, results = FALSE}
m.formula <- as.formula(paste0(DV, " ~ 1 + Association + Coherence + ", precrit2))
modelAndPlot(
  "Intercept+Association+Coherence+Precrit2",
  m.formula,
  df, m.type, regions, DV,
  y.unit, y.range, y.range.res
)
```


#### Intercept + Association + Coherence + Precrit_RT1 + Precrit_RT2 + Plausible

```{r, results = FALSE}
m.formula <- as.formula(paste0(DV,
                               " ~ 1 + Association + Coherence + Plausible + ",
                               precrit1, " + ", precrit2))
modelAndPlot(
  "Intercept+Association+Coherence+Precrit1&2+Plausibility",
  m.formula,
  df, m.type, regions, DV,
  y.unit, y.range, y.range.res
)
```



### Models with interaction terms

#### Association * Coherence

```{r, results = FALSE}
m.formula <- as.formula(paste0(DV, " ~ Association * Coherence "))
modelAndPlot(
  "Association*Coherence",
  m.formula,
  df, m.type, regions, DV,
  y.unit, y.range, y.range.res
)
```

#### Association * Coherence * precrit1

```{r, results = FALSE}
m.formula <- as.formula(paste0(DV, " ~ Association * Coherence * ", precrit1))
modelAndPlot(
  "Association*Coherence*Precrit1",
  m.formula,
  df, m.type, regions, DV,
  y.unit, y.range, y.range.res
)
```

#### Association * Coherence * precrit2

```{r, results = FALSE, fig.height = 6, fig.width = 9}
m.formula <- as.formula(paste0(DV, " ~ Association * Coherence * ", precrit2))
modelAndPlot(
  "Association*Coherence*Precrit2",
  m.formula,
  df, m.type, regions, DV,
  y.unit, y.range, y.range.res
)
```

#### Intercept + Association * Coherence * precrit1 * precrit2

```{r, results = FALSE, fig.height = 6, fig.width = 9}
m.formula <- as.formula(paste0(DV, " ~ Association * Coherence * ",
                               precrit1, " * ", precrit2))
modelAndPlot(
  "Association*Coherence*Precrit1*Precrit2",
  m.formula,
  df, m.type, regions, DV,
  y.unit, y.range, y.range.res,
  coef.plot = FALSE  # since too many coefficients 
)
```


#### Intercept + Association + Coherence + Association : Coherence + RT_Precrit1

```{r, results = FALSE}
m.formula <- as.formula(paste0(
  DV,
  " ~ Association + Coherence + Association:Coherence + ",
  precrit1
))

modelAndPlot(
  "Intercept+Association+Coherence+Association:Coherence+Precrit1",
  m.formula,
  df, m.type, regions, DV,
  y.unit, y.range, y.range.res
)
```


### lmer 


#### Intercept + Coherence, Random Intercepts 

```{r, results = FALSE}
m.formula <- as.formula(paste0(DV, " ~ 1 + Coherence +
                              (1 | Item) + (1 | Subject)"))
modelAndPlot(
  "Intercept+Coherence",
  m.formula,
  df, "lmer", regions, DV,
  y.unit, y.range, y.range.res
)

```

#### Intercept + Association + Coherence, Random Intercepts 

```{r, results = FALSE}
m.formula <- as.formula(paste0(DV, " ~ 1 + Association + Coherence +
                              (1 | Item) + (1 | Subject)"))
modelAndPlot(
  "Intercept+Association+Coherence",
  m.formula,
  df, "lmer", regions, DV,
  y.unit, y.range, y.range.res
)
```


#### Intercept + Association + Coherence + Precrit1, Random Intercepts 

```{r, results = FALSE}
m.formula <- as.formula(paste0(DV, " ~ 1 + Association + Coherence + ",
                               precrit1,
                              " + (1 | Item) + (1 | Subject)"))
modelAndPlot(
  "Intercept+Association+Coherence+Precrit1",
  m.formula,
  df, "lmer", regions, DV,
  y.unit, y.range, y.range.res
)
```


#### Intercept + Association + Coherence + Precrit1 + Association:Coherence, Random Intercepts 

```{r, results = FALSE}
m.formula <- as.formula(paste0(DV, " ~ 1 + Association + Coherence + Association:Coherence + ",
                               precrit1,
                              " + (1 | Item) + (1 | Subject)"))
modelAndPlot(
  "Intercept+Association+Coherence+Association:Coherence+Precrit1",
  m.formula,
  df, "lmer", regions, DV,
  y.unit, y.range, y.range.res
)
```

#### Intercept + Association*Coherence*Precrit1, Random Intercepts 

```{r, results = FALSE}
m.formula <- as.formula(paste0(DV, " ~ 1 + Association* Coherence * ",
                               precrit1,
                              " + (1 | Item) + (1 | Subject)"))
modelAndPlot(
  "Association*Coherence*Precrit1",
  m.formula,
  df, "lmer", regions, DV,
  y.unit, y.range, y.range.res
)
```

### Setting predictors to zero

```{r}
m.formula <- as.formula(paste0(DV, " ~ 1 + Association + Coherence +",
                               precrit1))
m <- runModels(df,
               "lm.by.subj",
               m.formula,
               regions)

# Set predictors to zero
m$ZeroAssoc <- m$`Coef_(Intercept)` + m$Association*0  + m$Coherence*m$Coef_Coherence + m$logRT_precrit1*m$Coef_logRT_precrit1
m$ZeroCoherence <- m$`Coef_(Intercept)` + m$Association*m$Coef_Association  + m$Coherence*0 + m$logRT_precrit1*m$Coef_logRT_precrit1

m$ZeroPrecrit1 <- m$`Coef_(Intercept)` + m$Association*m$Coef_Association  + m$Coherence*m$Coef_Coherence + m$logRT_precrit1*0

plotSPR(m, "ZeroAssoc", "Estimates: Association*0", y.unit, y.range)
plotSPR(m, "ZeroCoherence", "Estimates: Coherence*0", y.unit, y.range)
plotSPR(m, "logRT_precrit1", "Estimates: Precrit1*0", y.unit, y.range)
```


### Models with ProductionNorms as predictor

#### Intercept + ProdNorms

```{r, results = FALSE}
# Model formula
m.formula <- as.formula(paste0(DV, " ~ 1 + Association + Coherence + ", precrit2))

# Run a model for each region
m.intercept.assoc.coherence.precrit2 <- runModels(df, m.type, m.formula, regions = regions)

# Generate plots
p <- generatePlots(m.intercept.assoc.coherence.precrit2,
                   "Intercept+Association+Coherence+Precrit2", m.type, DV,
                   y.unit, y.range, y.range.res)
```




```{r, results = FALSE, eval = FALSE}
m.formula <- as.formula(paste0(DV, " ~ 1 + Coherence + (1 + Coherence | Item) +
                               (1 + Coherence | Subject)"))


m.lmer <- lmer(RT ~ 1 + Association + Coherence + (1 + Coherence| Subject) + (1 +Coherence | Item),
           data = filter(df, Region == 0))
summary(m.lmer)


#TODO add interaction term 
#TODO: set individual predictors to zero from full model and inspect/plot (plot estimate vs. residual)
#TODO: check if lmer fixed eff coefs are comparable to lm fixed eff coefs 
#TODO loop over subjects, individual model per subject, then average 


# Model output 
fixef(m.lmer)  # fixed effects 
summary(m.lmer)$coefficients
coef(m.lmer)   # subject/item estimates
ranef(m.lmer)  # deviation of subject/item from main effect

# Subject estimates with coef() are equal to main effect + ranef():
est <- ranef(m.lmer)$Subject
cf <- coef(m.lmer)$Subject
est$"(Intercept)" + fixef(m.lmer)[[1]] == cf$"(Intercept)"


  
subj.coef <- coef(m.lmer)$Subject
item.coef <- coef(m.lmer)$Item
subj.ranef <- ranef(m.lmer)$Subject
item.ranef <- ranef(m.lmer)$Item

mean(subj.coef$Coherence)
mean(item.coef$Coherence)
range(subj.coef$Coherence)
range(item.coef$Coherence)
round(mean(subj.ranef$Coherence), 5)
round(mean(item.ranef$Coherence), 5)

mean(subj.coef[, 1])
mean(item.coef[, 1])
range(subj.coef[, 1])
range(item.coef[, 1])
round(mean(subj.ranef[, 1]), 5)
round(mean(item.ranef[, 1]), 5)

coef(summary(m.lmer))
```

